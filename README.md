# Reverse Proxy by nginx and docker networks

## Introduction

The purpose of this repository is building reverse proxy communicating internal docker networks.

## Installation

1. `git clone` this directory.

```
~$ git clone <repository>
~$ cd reverse_proxy
```

2. Initialize local setup environment, with generating server definition file in env/ and creating working directory env/reverse_proxy.

```
~/reverse_proxy$ ./init.sh
~/reverse_proxy$ cat env/servers.csv # Confirm
#SERVER,LOCATION,CONTAINER,CONTAINER_PORT,CONTAINER_NETWORK,METHODS,AUTH_MSG
~/reverse_proxy$ cat env/_htpasswd # Confirm
```

3. Edit server definition file.

```
~/reverse_proxy$ vi env/servers.csv
```

4. Edit .htpasswd for authentication, if necessary.

```
~/reverse_proxy$ sudo htpasswd -b _htpasswd <auth_user> <auth_password>
```

4. Generate docker-compose.yml and conf files for nginx.

    1. If SSL is not necessary, use setup.sh.
    ```
    ~/reverse_proxy$ ./setup.sh
    ```

    2. If SSL is necessary, use setup.ssl.sh.  In this case, you must also set up letsencrypt in /etc/letsencrypt on host.

    ```
    ~/reverse_proxy$ ./setup.ssl.sh
    ```

- You will find some files after executing setup.sh.

    - env/reverse_proxy/default.conf ... 0 byte file prepared to overwrite the original file.
    - env/reverse_proxy/docker-compose.yml ... docker-compose.yml
    - env/reverse_proxy/nginx.conf ... /etc/nginx/nginx.conf in reverse proxy server container.
    - env/reverse_proxy/rp.conf ... Server definition. /etc/nginx/conf.d/rp.conf in reverse proxy server container.

5. Run docker-compose.

```
~/reverse_proxy$ cd env/reverse_proxy
~/reverse_proxy/env/reverse_proxy$ docker-compose up -d
~/reverse_proxy/env/reverse_proxy$ docker-compose ps # Confirm status
~/reverse_proxy/env/reverse_proxy$ docker-compose logs # Confirm logs
```
6. Test (samples)

```
~/reverse_proxy/env/reverse_proxy$ curl http://hoge.mydomain.com/
~/reverse_proxy/env/reverse_proxy$ curl http://hage.mydomain.com/
~/reverse_proxy/env/reverse_proxy$ curl http://root.mydomain.com/hoge/
```

# SSL with letsencrypt

1. Generate certificate by letsencrypt

```
$ sudo ls /etc/letsencrypt/live/[mydomain.com]
README  cert.pem  chain.pem  fullchain.pem  privkey.pem
```

2. Use setup.ssl.sh instead of setup.sh.


# Sample input/output

## env/reverse_proxy/servers.csv (input)

```
#SERVER,LOCATION,CONTAINER,CONTAINER_PORT,CONTAINER_NETWORK,METHODS,AUTH_MSG
hoge.mydomain.com,/,docker-container1,80,docker-network1
hage.mydomain.com,/,docker-container2,8080,docker-network2,GET|PUT
hage-restrict.mydomain.com,/,docker-container2,8080,docker-network2,,Authentication
root.mydomain.com,/hoge/,docker-container1,80,docker-network1
```

## env/reverse_proxy/rp.conf (generated by setup.sh)

```
server {
    listen 80;
    server_name hage-restrict.mydomain.com;

    location / {
        auth_basic "Authentication";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_set_header  Host                $host;
        proxy_set_header  X-Real-IP           $remote_addr;
        proxy_set_header  X-Forwarded-Host    $host;
        proxy_set_header  X-Forwarded-Server  $host;
        proxy_set_header  X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_pass        http://docker-container2:8080/;
        proxy_redirect    default;
    }
}

server {
    listen 80;
    server_name hage.mydomain.com;

    location / {
        if ($request_method !~ ^(GET|PUT)$ ) {
            return 405;
        }
        proxy_set_header  Host                $host;
        proxy_set_header  X-Real-IP           $remote_addr;
        proxy_set_header  X-Forwarded-Host    $host;
        proxy_set_header  X-Forwarded-Server  $host;
        proxy_set_header  X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_pass        http://docker-container2:8080/;
        proxy_redirect    default;
    }
}

server {
    listen 80;
    server_name hoge.mydomain.com;

    location / {
        proxy_set_header  Host                $host;
        proxy_set_header  X-Real-IP           $remote_addr;
        proxy_set_header  X-Forwarded-Host    $host;
        proxy_set_header  X-Forwarded-Server  $host;
        proxy_set_header  X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_pass        http://docker-container1:80/;
        proxy_redirect    default;
    }
}

server {

    listen 80;
    server_name root.mydomain.com;

    location /hoge/ {
        proxy_set_header  Host                $host;
        proxy_set_header  X-Real-IP           $remote_addr;
        proxy_set_header  X-Forwarded-Host    $host;
        proxy_set_header  X-Forwarded-Server  $host;
        proxy_set_header  X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_pass        http://docker-container1:80/;
        proxy_redirect    default;
    }


    location / {
        return 444; 
    }

    error_page  400 403 404       /40x.html;
    location = /40x.html {
        root   /usr/share/nginx/html;
    }

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
```

## env/reverse_proxy/docker-compose.conf (generated by setup.sh)

```
version: '3'

services:
  reverse-proxy:
    image: nginx
    container_name: reverse-proxy
    command: sh -c "cp -f /etc/nginx/tmp/nginx.conf /etc/nginx && cp -f /etc/nginx/tmp/conf.d/*.conf /etc/nginx/conf.d && cp -f /etc/nginx/tmp/_htpasswd /etc/nginx/.htpasswd && echo -n > /usr/share/nginx/html/index.html && echo -n > /usr/share/nginx/html/40x.html && echo -n > /usr/share/nginx/html/50x.html && nginx -g 'daemon off;'"
    volumes:
      - ./nginx.conf:/etc/nginx/tmp/nginx.conf
      - ./default.conf:/etc/nginx/tmp/conf.d/default.conf
      - ./rp.conf:/etc/nginx/tmp/conf.d/rp.conf
      - ./_htpasswd:/etc/nginx/tmp/_htpasswd
    ports:
      - 80:80
    networks:
      - docker-network1
      - docker-network2
networks:
  docker-network1:
    external: true
  docker-network2:
    external: true
```

# Detail of files generated by setup.sh

- env/reverse_proxy/nginx.conf
  - Copy of nginx.conf.template
- env/reverse_proxy/default.conf
  - Copy of default.conf.template
- env/reverse_proxy/rp.conf
  - (a) If the location root (/) is defined:
    - Replacing server, location and container information of rp.conf.template
  - (b) Otherwise:
    - Construct data from rp-noroot.conf.header.template, location data, and rp-noroot.conf.trailer.template
    - Location data is replaced server, location and container information of rp-noroot.conf.location.template
  - Finally concatenate files created by (a) and (b) processes
- env/reverse_proxy/docker-compose.yml
  - Concatenate some fragment files:
    - Container definition: docker-compose.yml.container.template
    - Docker service networks linked by the container: docker-compose.yml.services-networks.subsection.template
    - Docker external networks: docker-compose.yml.networks.section.template

# License

MIT License.
