# Reverse Proxy by nginx and docker networks

## Introduction

The purpose of this repository is building reverse proxy communicating internal docker networks.

## Architecture

## Installation

1. `git clone` this directory.

```
~$ git clone <repository>
~$ cd reverse_proxy
```

2. Initialize local setup environment, with generating server definition file in env/.

```
~/reverse_proxy$ ./init.sh
~/reverse_proxy$ cat env/servers.csv
#SERVER,LOCATION,CONTAINER,CONTAINER_PORT,CONTAINER_NETWORK
```
3. Edit server definition file.

```
~/reverse_proxy$ vi env/servers.csv
```

- Sample of server definition file.

```
#SERVER,LOCATION,CONTAINER,CONTAINER_PORT,CONTAINER_NETWORK
external-server.mydomain.com,/,docker-container1,80,docker-network1
external-server.mydomain.com,/hoge/,docker-container2,8080,docker-network2
ex.mydomain.com,/,docker-container1,80,docker-network1
```

4. Setup docker-compose.yml and conf files for nginx.

```
~/reverse_proxy$ ./setup.sh
```

- You will find some files after setup 4.

    - env/default.conf ... 0 byte file prepared to overwrite the original file.
    - env/docker-compose.yml ... docker-compose.yml
    - env/nginx.conf ... /etc/nginx/nginx.conf in reverse proxy server container.
    - env/rp.conf ... Server definition. /etc/nginx/conf.d/rp.conf in reverse proxy server container.

5. Run docker-compose.

```
~/reverse_proxy$ cd env
~/reverse_proxy/env$ docker-compose up -d
~/reverse_proxy/env$ docker-compose ps # Confirm status
~/reverse_proxy/env$ docker-compose logs # Confirm logs
```
6. Test (samples)

```
~/reverse_proxy/env$ curl http://external-server.mydomain.com/
~/reverse_proxy/env$ curl http://external-server.mydomain.com/hoge/
~/reverse_proxy/env$ curl http://ex.mydomain.com/
```

# Detail of files generated by setup.sh

- env/nginx.conf
  - Copy of nginx.conf.template
- env/default.conf
  - Copy of default.conf.template
- env/rp.conf
  - (a) If the location root (http://external-server/) is defined:
    - Replacing server, location and container information of rp.conf.template
  - (b) Otherwise:
    - Construct data from rp-noroot.conf.header.template, location data, and rp-noroot.conf.trailer.template
    - Location data is replaced server, location and container information of rp-noroot.conf.location.template
  - Finally concatenate files created by (a) and (b) processes
- env/docker-compose.yml
  - Concatenate some fragment files:
    - Container definition: docker-compose.yml.container.template
    - Docker service networks linked by the container: docker-compose.yml.services-networks.subsection.template
    - Docker external networks: docker-compose.yml.networks.section.template

# License

MIT License.
